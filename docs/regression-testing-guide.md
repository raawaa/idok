# JavSPé£æ ¼å›å½’æµ‹è¯•æŒ‡å—

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨åŸºäºJavSPè®¾è®¡æ€æƒ³çš„å›å½’æµ‹è¯•æ¡†æ¶ï¼Œè¯¥æ¡†æ¶ä¸ºweb-scraperæ¨¡å—æä¾›äº†å®Œæ•´çš„æ•°æ®é©±åŠ¨æµ‹è¯•è§£å†³æ–¹æ¡ˆã€‚

## æ¦‚è¿°

è¿™ä¸ªæµ‹è¯•æ¡†æ¶å‚è€ƒäº†æˆç†Ÿçš„JavSPé¡¹ç›®çš„æµ‹è¯•æœºåˆ¶ï¼Œæä¾›äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

- **æ•°æ®é©±åŠ¨æµ‹è¯•**: ä½¿ç”¨çœŸå®çš„æ•°æ®è¿›è¡Œå›å½’æµ‹è¯•
- **æ™ºèƒ½å­—æ®µæ¯”è¾ƒ**: é’ˆå¯¹ä¸åŒç±»å‹å­—æ®µé‡‡ç”¨ä¸åŒçš„æ¯”è¾ƒç­–ç•¥
- **å¤šæ ¼å¼æŠ¥å‘Š**: æ”¯æŒHTMLã€JSONã€JUnitç­‰å¤šç§æŠ¥å‘Šæ ¼å¼
- **è‡ªåŠ¨æ›´æ–°æœºåˆ¶**: æ™ºèƒ½è¯†åˆ«å’Œæ›´æ–°è¿‡æœŸçš„åŸºå‡†æ•°æ®
- **Jesté›†æˆ**: ä¸ä¸»æµæµ‹è¯•æ¡†æ¶æ— ç¼é›†æˆ

## æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

1. **TestDataManager** (`tests/integration/utils/test-data-manager.js`)
   - ç®¡ç†åŸºå‡†æ•°æ®å’Œå½“å‰æ•°æ®
   - æ”¯æŒå¤šç¯å¢ƒé…ç½®
   - æä¾›æ•°æ®æ ¼å¼è½¬æ¢åŠŸèƒ½

2. **DataComparator** (`tests/integration/utils/data-comparator.js`)
   - æ™ºèƒ½å­—æ®µæ¯”è¾ƒç®—æ³•
   - æ”¯æŒå¤šç§æ¯”è¾ƒç­–ç•¥ï¼ˆæ—¶é—´æ•æ„Ÿã€URLè·¯å¾„ã€åˆ—è¡¨é¡ºåºç­‰ï¼‰
   - æä¾›ç›¸ä¼¼åº¦è®¡ç®—å’Œå·®å¼‚åˆ†æ

3. **TestReporter** (`tests/integration/utils/test-reporter.js`)
   - ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Š
   - æ”¯æŒHTMLå’ŒJSONæ ¼å¼
   - æä¾›å®æ—¶æ§åˆ¶å°è¾“å‡º

4. **RegressionTestRunner** (`tests/integration/regression-test-runner.js`)
   - æ ¸å¿ƒæµ‹è¯•æ‰§è¡Œå¼•æ“
   - æ”¯æŒå¹¶è¡Œå’Œä¸²è¡Œæ‰§è¡Œ
   - æä¾›é‡è¯•å’Œé”™è¯¯å¤„ç†æœºåˆ¶

## å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ç”¨æ³•

```bash
# è¿è¡Œå®Œæ•´çš„å›å½’æµ‹è¯•å¥—ä»¶
npm run test:regression

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
npm run test:regression:verbose

# ä½¿ç”¨Jestè¿è¡Œå›å½’æµ‹è¯•
npm run test:regression:jest

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:regression:jest:coverage
```

### 2. æµ‹è¯•ç‰¹å®šé¡¹ç›®

```bash
# æµ‹è¯•ç‰¹å®šAVID
node scripts/run-regression-tests.js IPX-177

# æµ‹è¯•ç‰¹å®šçˆ¬è™«
node scripts/run-regression-tests.js --scraper javbus

# æµ‹è¯•ç‰¹å®šAVIDå’Œçˆ¬è™«ç»„åˆ
node scripts/run-regression-tests.js --avid IPX-177 --scraper javbus
```

### 3. æŸ¥çœ‹æµ‹è¯•è®¡åˆ’

```bash
# å¹²è¿è¡Œæ¨¡å¼ï¼Œåªæ˜¾ç¤ºå°†è¦æ‰§è¡Œçš„æµ‹è¯•
npm run test:regression:dry-run
```

### 4. æ›´æ–°åŸºå‡†æ•°æ®

```bash
# æ›´æ–°ç‰¹å®šé¡¹ç›®çš„åŸºå‡†æ•°æ®
node scripts/run-regression-tests.js --avid IPX-177 --scraper javbus --update-baseline

# è‡ªåŠ¨æ›´æ–°æ‰€æœ‰éœ€è¦æ›´æ–°çš„åŸºå‡†æ•°æ®
npm run test:regression:auto-update

# æŸ¥çœ‹è‡ªåŠ¨æ›´æ–°è®¡åˆ’
npm run test:regression:auto-update:dry-run
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

- `HTTP_PROXY`: HTTPä»£ç†åœ°å€ (é»˜è®¤: `http://127.0.0.1:10809`)
- `HTTPS_PROXY`: HTTPSä»£ç†åœ°å€ (é»˜è®¤: `http://127.0.0.1:10809`)
- `NODE_ENV`: è¿è¡Œç¯å¢ƒ (é»˜è®¤: `development`)
- `VERBOSE`: è¯¦ç»†è¾“å‡ºæ¨¡å¼ (é»˜è®¤: `false`)

### æ¯”è¾ƒç­–ç•¥é…ç½®

DataComparatoræ”¯æŒä»¥ä¸‹å­—æ®µæ¯”è¾ƒç­–ç•¥ï¼š

1. **æ—¶é—´æ•æ„Ÿå­—æ®µ** (`score`, `userScore`, `commentCount`, `viewCount`)
   - åªæ¯”è¾ƒå­—æ®µçš„å­˜åœ¨æ€§ï¼Œå¿½ç•¥å…·ä½“æ•°å€¼

2. **URLå­—æ®µ** (`cover`, `bigCover`, `previewVideo`, `magnet`)
   - åªæ¯”è¾ƒURLè·¯å¾„éƒ¨åˆ†ï¼Œå¿½ç•¥åŸŸåå·®å¼‚

3. **åˆ—è¡¨å­—æ®µ** (`genre`, `actress`, `tags`)
   - å¿½ç•¥å…ƒç´ é¡ºåºï¼Œæ¯”è¾ƒé›†åˆå†…å®¹

4. **æ–‡æœ¬å­—æ®µ** (`title`, `plot`, `description`)
   - æ”¯æŒæ ‡å‡†åŒ–æ¯”è¾ƒå’Œæ¨¡ç³ŠåŒ¹é…

5. **å›¾ç‰‡é›†åˆå­—æ®µ** (`actress_pics`, `preview_pics`)
   - æå–å›¾ç‰‡è·¯å¾„è¿›è¡Œæ¯”è¾ƒ

### è‡ªåŠ¨æ›´æ–°é…ç½®

è‡ªåŠ¨æ›´æ–°æœºåˆ¶è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š

1. **æ•°æ®å¹´é¾„**: è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ•°æ®ä¼šè¢«æ ‡è®°ä¸ºéœ€è¦æ›´æ–°
2. **æ•°æ®è´¨é‡**: ç¼ºå°‘å…³é”®å­—æ®µçš„æ•°æ®ä¼šè¢«æ ‡è®°
3. **åŒ¹é…ç‡**: ä¸å½“å‰æ•°æ®åŒ¹é…ç‡è¿‡ä½çš„æ•°æ®ä¼šè¢«æ ‡è®°
4. **æ–°å­—æ®µ**: å‘ç°æ–°å¢å­—æ®µçš„æ•°æ®ä¼šè¢«æ ‡è®°

## æµ‹è¯•æ•°æ®æ ¼å¼

### åŸºå‡†æ•°æ®æ ¼å¼

åŸºå‡†æ•°æ®é‡‡ç”¨JavSPå…¼å®¹çš„JSONæ ¼å¼ï¼š

```json
{
  "dvdid": "IPX-177",
  "cid": null,
  "url": "https://www.javbus.com/IPX-177",
  "title": "ç”Ÿæ„æ°—ãªå¦¹ã«ãƒ‹ãƒ¼ãƒã‚¤ã‚’å±¥ã‹ã›åƒ•ã ã‘ã®ã€Œçµ¶å¯¾é ˜åŸŸã€ã‚’èª•ç”Ÿã•ã›åƒ•å¥½ã¿ã«ç—´å¥³ã‚‰ã›ãŸã€‚ ç›¸æ²¢ã¿ãªã¿",
  "cover": "https://www.javbus.com/pics/cover/6n54_b.jpg",
  "genre": ["å–®é«”ä½œå“", "DMMç¨å®¶", "æ‰“æ‰‹æ§"],
  "actress": ["ç›¸æ²¢ã¿ãªã¿"],
  "release_date": "2018-07-14",
  "duration": "170"
}
```

### å­—æ®µæ˜ å°„

æµ‹è¯•æ¡†æ¶è‡ªåŠ¨åœ¨JavSPæ ¼å¼å’Œé¡¹ç›®æ ¼å¼ä¹‹é—´è¿›è¡Œè½¬æ¢ï¼š

| JavSPå­—æ®µ | é¡¹ç›®å­—æ®µ | è¯´æ˜ |
|-----------|----------|------|
| `dvdid` | `avid` | ç•ªå· |
| `cover` | `cover` | å°é¢å›¾ |
| `big_cover` | `bigCover` | å¤§å°é¢å›¾ |
| `preview_video` | `previewVideo` | é¢„è§ˆè§†é¢‘ |
| `actress_pics` | `actressPics` | æ¼”å‘˜å›¾ç‰‡ |
| `preview_pics` | `previewPics` | é¢„è§ˆå›¾ç‰‡ |
| `release_date` | `releaseDate` | å‘å¸ƒæ—¥æœŸ |

## æŠ¥å‘Šè¯´æ˜

### HTMLæŠ¥å‘Š

HTMLæŠ¥å‘Šæä¾›äº†äº¤äº’å¼çš„æµ‹è¯•ç»“æœæŸ¥çœ‹ç•Œé¢ï¼š

- **æµ‹è¯•æ‘˜è¦**: æ˜¾ç¤ºæ€»ä½“ç»Ÿè®¡ä¿¡æ¯
- **æµ‹è¯•å¥—ä»¶**: æŒ‰çˆ¬è™«åˆ†ç»„æ˜¾ç¤ºæµ‹è¯•ç»“æœ
- **è¯¦ç»†å·®å¼‚**: å±•ç¤ºå­—æ®µçº§åˆ«çš„å·®å¼‚å¯¹æ¯”
- **ä¸¥é‡ç¨‹åº¦**: ç”¨é¢œè‰²æ ‡è¯†å·®å¼‚çš„ä¸¥é‡ç¨‹åº¦

### JSONæŠ¥å‘Š

JSONæŠ¥å‘ŠåŒ…å«å®Œæ•´çš„æµ‹è¯•æ•°æ®ï¼Œä¾¿äºç¨‹åºåŒ–å¤„ç†ï¼š

```json
{
  "summary": {
    "totalTests": 10,
    "passed": 8,
    "failed": 2,
    "successRate": 80
  },
  "suites": [...],
  "globalStats": {...}
}
```

### æ§åˆ¶å°è¾“å‡º

å®æ—¶æ˜¾ç¤ºæµ‹è¯•è¿›åº¦å’Œç»“æœï¼š

```
ğŸš€ JavSPé£æ ¼å›å½’æµ‹è¯•å·¥å…·
============================================================
ğŸ” æµ‹è¯• IPX-177 (javbus)
âœ… IPX-177 (javbus) - é€šè¿‡ (95%)
ğŸ” æµ‹è¯• 130614-KEIKO (javbus)
âŒ 130614-KEIKO (javbus) - å¤±è´¥ (78%)
```

## æœ€ä½³å®è·µ

### 1. æµ‹è¯•æ•°æ®ç®¡ç†

- å®šæœŸæ›´æ–°åŸºå‡†æ•°æ®ä»¥åæ˜ ç½‘ç«™å˜åŒ–
- ä½¿ç”¨æœ‰ä»£è¡¨æ€§çš„æµ‹è¯•ç”¨ä¾‹è¦†ç›–å„ç§AVIDæ ¼å¼
- ä¿æŒæµ‹è¯•æ•°æ®çš„å¤šæ ·æ€§å’Œå®Œæ•´æ€§

### 2. æ¯”è¾ƒç­–ç•¥è°ƒæ•´

- æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´å­—æ®µæ¯”è¾ƒç­–ç•¥
- å¯¹äºç»å¸¸å˜åŒ–çš„å­—æ®µä½¿ç”¨æ—¶é—´æ•æ„Ÿç­–ç•¥
- å¯¹äºé‡è¦å­—æ®µä½¿ç”¨ä¸¥æ ¼æ¯”è¾ƒæ¨¡å¼

### 3. è‡ªåŠ¨æ›´æ–°é…ç½®

- è®¾ç½®åˆç†çš„æ›´æ–°é˜ˆå€¼ï¼ˆåŒ¹é…ç‡ã€æ•°æ®å¹´é¾„ç­‰ï¼‰
- åœ¨CI/CDä¸­å®šæœŸè¿è¡Œè‡ªåŠ¨æ›´æ–°æ£€æŸ¥
- ä¿ç•™å¤‡ä»½ä»¥ä¾¿å›æ»š

### 4. æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œæé«˜æµ‹è¯•é€Ÿåº¦
- è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
- é™åˆ¶å¹¶å‘æ•°é¿å…å¯¹ç›®æ ‡ç½‘ç«™é€ æˆå‹åŠ›

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç½‘ç»œè¿æ¥é—®é¢˜**
   ```
   é”™è¯¯: è·å–å½“å‰æ•°æ®å¤±è´¥: connect ETIMEDOUT
   è§£å†³: æ£€æŸ¥ä»£ç†è®¾ç½®å’Œç½‘ç»œè¿æ¥
   ```

2. **æµ‹è¯•æ•°æ®ç¼ºå¤±**
   ```
   é”™è¯¯: åŸºå‡†æ•°æ®ä¸å­˜åœ¨: IPX-177 (javbus)
   è§£å†³: ç¡®ä¿æµ‹è¯•æ•°æ®æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
   ```

3. **çˆ¬è™«å¼‚å¸¸**
   ```
   é”™è¯¯: çˆ¬è™«å¼‚å¸¸: ç½‘ç«™ç»“æ„å¯èƒ½å·²æ”¹å˜
   è§£å†³: æ£€æŸ¥ç›®æ ‡ç½‘ç«™æ˜¯å¦å¯è®¿é—®ï¼Œçˆ¬è™«æ˜¯å¦éœ€è¦æ›´æ–°
   ```

### è°ƒè¯•æŠ€å·§

1. **ä½¿ç”¨è¯¦ç»†è¾“å‡ºæ¨¡å¼**
   ```bash
   npm run test:regression:verbose
   ```

2. **å•ç‹¬æµ‹è¯•ç‰¹å®šé¡¹ç›®**
   ```bash
   node scripts/run-regression-tests.js --avid IPX-177 --verbose
   ```

3. **æ£€æŸ¥ç”Ÿæˆçš„æŠ¥å‘Š**
   - æŸ¥çœ‹ `tests/integration/data/reports/` ç›®å½•ä¸‹çš„æŠ¥å‘Šæ–‡ä»¶
   - é‡ç‚¹å…³æ³¨å¤±è´¥æµ‹è¯•çš„è¯¦ç»†å·®å¼‚ä¿¡æ¯

4. **éªŒè¯æ•°æ®è´¨é‡**
   ```bash
   node scripts/auto-update-baseline.js --dry-run --verbose
   ```

## é›†æˆåˆ°CI/CD

### GitHub Actionsç¤ºä¾‹

```yaml
name: Regression Tests

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run regression tests
        run: npm run test:regression:jest
        env:
          HTTP_PROXY: ${{ secrets.HTTP_PROXY }}
          HTTPS_PROXY: ${{ secrets.HTTPS_PROXY }}

      - name: Upload test reports
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: test-reports
          path: |
            coverage/
            tests/integration/data/reports/
```

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„æ¯”è¾ƒç­–ç•¥

1. åœ¨ `DataComparator` ä¸­æ·»åŠ æ–°çš„ç­–ç•¥ç±»å‹
2. å®ç°å¯¹åº”çš„æ¯”è¾ƒæ–¹æ³•
3. æ›´æ–°å­—æ®µæ˜ å°„é…ç½®

### æ·»åŠ æ–°çš„æŠ¥å‘Šæ ¼å¼

1. åœ¨ `TestReporter` ä¸­æ·»åŠ æ–°çš„ç”Ÿæˆæ–¹æ³•
2. å®ç°æ ¼å¼ç‰¹å®šçš„æ¨¡æ¿å’Œæ ·å¼
3. æ›´æ–°é…ç½®é€‰é¡¹

### é›†æˆæ–°çš„çˆ¬è™«

1. ç¡®ä¿çˆ¬è™«å®ç°äº†æ ‡å‡†æ¥å£
2. åœ¨ `supportedScrapers` åˆ—è¡¨ä¸­æ·»åŠ çˆ¬è™«åç§°
3. å‡†å¤‡å¯¹åº”çš„åŸºå‡†æµ‹è¯•æ•°æ®

## å‚è€ƒèµ„æ–™

- [JavSPé¡¹ç›®](https://github.com/yoshiko2/AV_Data_Capture)
- [Jestæ–‡æ¡£](https://jestjs.io/docs/getting-started)
- [Node.jsæµ‹è¯•æœ€ä½³å®è·µ](https://github.com/goldbergyoni/nodebestpractices#--testing-and-overall-code-quality)

---

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æˆ–æäº¤Issueã€‚