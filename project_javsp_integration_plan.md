# JavSP番号识别模块集成规划

## 🎯 项目目标

将JavSP番号识别模块集成到idok项目中，实现以下核心功能：
- 支持独立视频文件的番号识别
- 提供持久化存储避免重复扫描
- 保持与现有Kodi标准NFO解析的兼容性
- 提供渐进式集成方案，确保系统稳定性

## 📋 任务清单与执行顺序

### 第一阶段：测试基础设施建设
**目标**：建立完善的测试框架，确保代码质量

#### 任务1.1：安装测试框架
- [ ] 安装Jest测试框架
- [ ] 配置测试脚本和覆盖率报告
- [ ] 创建测试目录结构
- [ ] 编写测试配置文档

#### 任务1.2：创建测试数据
- [ ] 创建模拟视频文件和NFO文件
- [ ] 准备各种番号格式的测试用例
- [ ] 建立测试数据管理规范

### 第二阶段：数据库服务开发
**目标**：实现可靠的持久化存储

#### 任务2.1：设计数据模型
```javascript
// 媒体文件数据结构
{
  filePath: "D:\\Videos\\ABC-123.mp4",
  fileType: "raw-video" | "kodi-standard",
  lastModified: 1234567890,
  fileSize: 1234567890,
  avid: "ABC-123",           // 番号识别结果
  confidence: 0.9,          // 识别置信度
  metadata: {
    title: "影片标题",
    actors: ["演员1", "演员2"],
    genres: ["分类1", "分类2"],
    studio: "制作商",
    series: "系列",
    releaseDate: "2024-01-01",
    coverImage: "封面URL"
  },
  lastUpdated: "2024-01-15T10:30:00Z"
}
```

#### 任务2.2：实现JSON数据库服务
- [ ] 创建`database-service.js`
- [ ] 实现基本的CRUD操作
- [ ] 添加数据验证和错误处理
- [ ] 实现数据缓存机制

#### 任务2.3：编写数据库服务测试
- [ ] 测试数据存储和读取
- [ ] 测试数据更新和删除
- [ ] 测试并发访问处理
- [ ] 测试数据完整性验证

### 第三阶段：扫描逻辑重构
**目标**：支持独立视频文件识别

#### 任务3.1：分析现有扫描逻辑
- [ ] 研究`media-service.js`的当前实现
- [ ] 识别需要修改的关键点
- [ ] 设计新的扫描策略

#### 任务3.2：实现分层扫描策略
```
扫描流程：
1. 发现文件夹内有NFO文件？ → Kodi标准处理
2. 发现独立视频文件？ → 非标准处理
   ├── 尝试JavSP番号识别
   └── 尝试从文件名提取信息
3. 递归子目录
```

#### 任务3.3：实现新扫描方法
- [ ] 创建`scanRawVideoFiles()`方法
- [ ] 实现文件变化检测
- [ ] 添加扫描进度报告
- [ ] 优化扫描性能

#### 任务3.4：编写扫描逻辑测试
- [ ] 测试Kodi标准文件识别
- [ ] 测试独立视频文件识别
- [ ] 测试混合目录处理
- [ ] 测试错误处理和边界情况

### 第四阶段：JavSP集成
**目标**：渐进式集成番号识别功能

#### 任务4.1：创建JavSP适配器
- [ ] 分析JavSP模块接口
- [ ] 创建`javsp-adapter.js`
- [ ] 实现错误处理和降级策略
- [ ] 添加配置选项

#### 任务4.2：实现番号识别
- [ ] 集成`avid-detector.js`
- [ ] 实现置信度评估
- [ ] 添加识别结果验证
- [ ] 实现回退机制

#### 任务4.3：实现元数据获取
- [ ] 集成`scraper-manager.js`
- [ ] 实现并发控制
- [ ] 添加缓存机制
- [ ] 处理网络错误

#### 任务4.4：编写JavSP集成测试
- [ ] 测试番号识别准确性
- [ ] 测试元数据获取功能
- [ ] 测试错误处理机制
- [ ] 测试性能表现

### 第五阶段：增量扫描和文件监控
**目标**：实现智能文件监控

#### 任务5.1：实现文件系统监控
- [ ] 集成`chokidar`文件监控库
- [ ] 实现文件变化监听
- [ ] 处理文件重命名和移动
- [ ] 实现批量变化处理

#### 任务5.2：实现增量更新
- [ ] 只处理新增/修改的文件
- [ ] 实现后台异步更新
- [ ] 添加更新队列管理
- [ ] 优化更新性能

#### 任务5.3：编写增量扫描测试
- [ ] 测试文件变化检测
- [ ] 测试增量更新逻辑
- [ ] 测试并发更新处理
- [ ] 测试系统稳定性

### 第六阶段：UI集成和用户体验
**目标**：提供友好的用户界面

#### 任务6.1：设置界面扩展
- [ ] 添加"启用JavSP识别"选项
- [ ] 添加识别结果对比功能
- [ ] 实现手动校正界面
- [ ] 添加扫描进度显示

#### 任务6.2：媒体列表增强
- [ ] 显示识别置信度
- [ ] 添加番号标签显示
- [ ] 实现识别状态指示
- [ ] 添加批量操作功能

#### 任务6.3：用户反馈机制
- [ ] 实现识别结果反馈
- [ ] 添加错误报告功能
- [ ] 实现使用统计
- [ ] 添加帮助文档

### 第七阶段：性能优化和稳定性
**目标**：确保系统长期稳定运行

#### 任务7.1：性能优化
- [ ] 优化数据库查询性能
- [ ] 实现智能缓存策略
- [ ] 优化内存使用
- [ ] 添加性能监控

#### 任务7.2：错误处理和恢复
- [ ] 完善错误处理机制
- [ ] 实现自动重试逻辑
- [ ] 添加系统恢复功能
- [ ] 实现降级策略

#### 任务7.3：系统测试
- [ ] 进行压力测试
- [ ] 测试长时间运行稳定性
- [ ] 测试大数据量处理
- [ ] 验证内存泄漏

## 🧪 测试策略

### 单元测试
- **覆盖率目标**：>80%
- **测试重点**：核心逻辑、边界情况、错误处理
- **测试工具**：Jest + 自定义测试工具

### 集成测试
- **测试场景**：完整扫描流程、混合文件处理、并发访问
- **测试数据**：真实文件样本、各种边界情况
- **性能测试**：扫描速度、内存使用、并发处理

### 用户验收测试
- **功能验证**：所有用户故事都能正常工作
- **用户体验**：界面友好、响应迅速、错误提示清晰
- **稳定性测试**：长时间运行无崩溃、内存无泄漏

## 📊 成功标准

### 功能标准
- [ ] 支持90%以上的常见番号格式
- [ ] 识别准确率>85%
- [ ] 扫描1000个文件<30秒
- [ ] 内存使用<500MB

### 质量标准
- [ ] 代码覆盖率>80%
- [ ] 无严重bug
- [ ] 性能指标达标
- [ ] 用户反馈良好

### 兼容性标准
- [ ] 与现有NFO解析完全兼容
- [ ] 支持Windows系统
- [ ] 支持各种视频格式
- [ ] 支持网络代理

## 🚨 风险控制

### 技术风险
- **JavSP模块稳定性**：充分测试，准备降级方案
- **性能问题**：渐进式优化，及时监控
- **数据安全**：本地存储，无隐私泄露

### 项目风险
- **进度延迟**：合理拆分任务，及时跟进
- **质量问题**：测试驱动开发，持续集成
- **用户接受度**：渐进式发布，收集反馈

## 📅 时间规划

预计总工期：4-6周
- 第一阶段：1周
- 第二阶段：1周  
- 第三阶段：1-2周
- 第四阶段：1-2周
- 第五阶段：1周
- 第六阶段：1周
- 第七阶段：1周

## 📝 执行记录

每次执行后在此记录：
- 完成的任务和成果
- 遇到的问题和解决方案
- 经验教训和改进建议
- 下一步计划调整

---

**文档维护**：每次执行后更新相关章节
**版本控制**：与代码同步更新
**责任人**：开发团队
**创建时间**：2024年1月15日