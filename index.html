<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>åª’ä½“èµ„æ–™åº“</title>
    <link rel="stylesheet" href="style.css">
    <script src="renderer.js"></script>
</head>

<body>
    <!-- è‡ªå®šä¹‰æ ‡é¢˜æ  -->
    <div id="custom-titlebar">
        <div id="app-title">ç”µå½±ç®¡ç†å™¨</div>
        <div id="window-controls">
            <button id="minimize-btn" class="window-control-btn">-</button>
            <button id="maximize-btn" class="window-control-btn">â–¡</button>
            <button id="close-btn" class="window-control-btn">Ã—</button>
        </div>
        <button id="theme-toggle" class="theme-toggle-btn" title="åˆ‡æ¢ä¸»é¢˜">
            <span class="theme-icon">ğŸŒ™</span>
        </button>
    </div>

    <!-- æ·»åŠ æ–°çš„å†…å®¹å®¹å™¨ -->
    <div id="content-container">
        <div id="controls" style="margin-bottom: 20px; text-align: center;">
            <label for="sort-by">æ’åºæ–¹å¼:</label>
            <select id="sort-by">
                <option value="title">ç‰‡å</option>
                <option value="releaseDate">å‘å¸ƒæ—¥æœŸ</option>
            </select>

            <label for="sort-order" style="margin-left: 10px;">é¡ºåº:</label>
            <select id="sort-order">
                <option value="asc">å‡åº</option>
                <option value="desc">é™åº</option>
            </select>

            <label for="filter-actor" style="margin-left: 20px;">æ¼”å‘˜:</label>
            <input type="text" id="filter-actor" placeholder="è¾“å…¥æ¼”å‘˜å">

            <label for="filter-studio" style="margin-left: 20px;">ç‰‡å•†:</label>
            <input type="text" id="filter-studio" placeholder="è¾“å…¥ç‰‡å•†å">

            <label for="filter-genre" style="margin-left: 20px;">ç±»åˆ«:</label>
            <input type="text" id="filter-genre" placeholder="è¾“å…¥ç±»åˆ«å">

            <!-- æ¸…é™¤è¿‡æ»¤æŒ‰é’® -->
            <button id="clear-filters" style="margin-left: 20px;">æ¸…é™¤è¿‡æ»¤</button>

            <!-- è®¾ç½®æŒ‰é’® -->
            <button id="open-settings-btn" style="margin-left: 20px;">è®¾ç½®</button>

            <!-- å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šè¿‡æ»¤é€‰é¡¹ -->
        </div>

        <!-- è¿™é‡Œå°†æ˜¾ç¤ºç”µå½±å°é¢ -->
        <div id="movie-covers">

        </div>

        <!-- æ¨¡æ€æ¡†ç»“æ„ -->
        <div id="delete-modal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
            <div
                style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); text-align: center;">
                <h2>ç¡®è®¤åˆ é™¤</h2>
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹å½±ç‰‡ç›®å½•å—ï¼Ÿ</p>
                <p id="delete-path" style="font-weight: bold; margin: 10px 0; word-break: break-all;"></p>
                <div style="margin-top: 20px;">
                    <button id="confirm-delete-btn" style="margin-right: 10px;">ç¡®è®¤</button>
                    <button id="cancel-delete-btn">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ç»“æŸå†…å®¹å®¹å™¨ -->
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡†ç»“æ„ -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); width: 600px; max-height: 80%; overflow-y: auto;">
            <h2>è®¾ç½®</h2>
            <div id="settings-content">
                <!-- è¿™é‡Œå°†åŠ¨æ€åŠ è½½è®¾ç½®å†…å®¹ -->
            </div>
            <div style="margin-top: 20px; text-align: right;">
                <button id="save-settings-btn" style="margin-right: 10px;">ä¿å­˜</button>
                <button id="cancel-settings-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const path = require('path');

        let allMediaList = []; // å­˜å‚¨æ‰€æœ‰åª’ä½“æ•°æ®çš„åŸå§‹åˆ—è¡¨

        document.addEventListener('DOMContentLoaded', async () => {
            const movieCoversDiv = document.getElementById('movie-covers');
            // const directoryPath = 'd:\\Porn'; // è¿™é‡Œä½¿ç”¨ä½ æä¾›çš„è·¯å¾„

            const sortBySelect = document.getElementById('sort-by');
            const sortOrderSelect = document.getElementById('sort-order');
            const filterActorInput = document.getElementById('filter-actor');
            const filterStudioInput = document.getElementById('filter-studio');
            const filterGenreInput = document.getElementById('filter-genre'); // è·å–ç±»åˆ«è¿‡æ»¤è¾“å…¥æ¡†
            const clearFiltersButton = document.getElementById('clear-filters'); // è·å–æ¸…é™¤è¿‡æ»¤æŒ‰é’®
            const openSettingsBtn = document.getElementById('open-settings-btn'); // è·å–è®¾ç½®æŒ‰é’®

            // åœ¨ä¸»è¿›ç¨‹é€šçŸ¥å¯ä»¥å¼€å§‹åˆæ¬¡æ‰«ææ—¶è¿›è¡Œ
            ipcRenderer.on('start-initial-scan', async (event, directoryPaths) => {
                console.log("å¼€å§‹åˆæ¬¡æ‰«æ...");
                // è·å–åª’ä½“æ•°æ®
                allMediaList = await ipcRenderer.invoke('scan-directory', directoryPaths);
                console.log("åˆæ¬¡æ‰«æå®Œæˆï¼Œæ‰¾åˆ°", allMediaList.length, "ä¸ªåª’ä½“æ–‡ä»¶ã€‚");
                // åˆæ¬¡æ¸²æŸ“
                renderMediaList(allMediaList);
            });

            // å½“æ²¡æœ‰é…ç½®ç›®å½•æ—¶æ˜¾ç¤ºæç¤º
            ipcRenderer.on('no-directories-configured', () => {
                const movieCoversDiv = document.getElementById('movie-covers');
                movieCoversDiv.innerHTML = '<p>è¯·åœ¨è®¾ç½®ä¸­é…ç½®å½±ç‰‡ç›®å½•ã€‚</p>';
            });

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            sortBySelect.addEventListener('change', () => renderMediaList(allMediaList));
            sortOrderSelect.addEventListener('change', () => renderMediaList(allMediaList));
            filterActorInput.addEventListener('input', () => renderMediaList(allMediaList));
            filterStudioInput.addEventListener('input', () => renderMediaList(allMediaList));
            filterGenreInput.addEventListener('input', () => renderMediaList(allMediaList)); // æ·»åŠ ç±»åˆ«è¿‡æ»¤è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬

            // æ·»åŠ æ¸…é™¤è¿‡æ»¤æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            clearFiltersButton.addEventListener('click', () => {
                filterActorInput.value = ''; // æ¸…ç©ºæ¼”å‘˜è¿‡æ»¤è¾“å…¥æ¡†
                filterStudioInput.value = ''; // æ¸…ç©ºç‰‡å•†è¿‡æ»¤è¾“å…¥æ¡†
                filterGenreInput.value = ''; // æ¸…ç©ºç±»åˆ«è¿‡æ»¤è¾“å…¥æ¡†
                // æ¸…ç©ºå…¶ä»–è¿‡æ»¤è¾“å…¥æ¡† (å¦‚æœæ·»åŠ äº†)
                renderMediaList(allMediaList); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            });

            // æ·»åŠ æ‰“å¼€è®¾ç½®æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            openSettingsBtn.addEventListener('click', async () => {
                // ä»ä¸»è¿›ç¨‹è·å–å½“å‰è®¾ç½®
                const currentSettings = await ipcRenderer.invoke('get-settings');
                
                // åŠ¨æ€åˆ›å»ºè®¾ç½®è¡¨å•
                settingsContent.innerHTML = `
                    <div>
                        <h3>åª’ä½“åº“ç›®å½•</h3>
                        <div id="directory-list">
                            ${currentSettings.directories ? currentSettings.directories.map((dir, index) => `
                                <div class="directory-item" style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <input type="text" value="${dir}" readonly style="flex-grow: 1; margin-right: 10px;">
                                    <button class="remove-directory-btn" data-index="${index}">åˆ é™¤</button>
                                </div>
                            `).join('') : ''}
                        </div>
                        <button id="add-directory-btn">æ·»åŠ ç›®å½•</button>
                    </div>
                `;

                // æ·»åŠ ç›®å½•æŒ‰é’®äº‹ä»¶
                document.getElementById('add-directory-btn').addEventListener('click', async () => {
                    const result = await ipcRenderer.invoke('open-directory-dialog');
                    if (!result.canceled && result.filePaths.length > 0) {
                        const newDir = result.filePaths[0];
                        const directoryList = document.getElementById('directory-list');
                        directoryList.innerHTML += `
                            <div class="directory-item" style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="text" value="${newDir}" readonly style="flex-grow: 1; margin-right: 10px;">
                                <button class="remove-directory-btn" data-index="${directoryList.children.length}">åˆ é™¤</button>
                            </div>
                        `;
                    }
                });

                // åˆ é™¤ç›®å½•æŒ‰é’®äº‹ä»¶
                settingsContent.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-directory-btn')) {
                        e.target.closest('.directory-item').remove();
                    }
                });

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                settingsModal.style.display = 'block';
            });

            // ç›‘å¬è®¾ç½®ä¿å­˜æˆåŠŸçš„æ¶ˆæ¯ï¼Œç„¶åé‡æ–°æ‰«æ
            ipcRenderer.on('settings-saved-and-rescan', async () => {
                console.log("è®¾ç½®å·²ä¿å­˜ï¼Œé‡æ–°æ‰«æ...");
                // é‡æ–°è·å–è®¾ç½®ï¼ˆåŒ…å«æ›´æ–°åçš„ç›®å½•ï¼‰å¹¶è§¦å‘æ‰«æ
                const settings = await ipcRenderer.invoke('get-settings');
                if (settings && settings.directories && settings.directories.length > 0) {
                    allMediaList = await ipcRenderer.invoke('scan-directory', settings.directories);
                    console.log("é‡æ–°æ‰«æå®Œæˆï¼Œæ‰¾åˆ°", allMediaList.length, "ä¸ªåª’ä½“æ–‡ä»¶ã€‚");
                    renderMediaList(allMediaList);
                } else {
                    // å¦‚æœä¿å­˜åç›®å½•ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤º
                    const movieCoversDiv = document.getElementById('movie-covers');
                    movieCoversDiv.innerHTML = '<p>è¯·åœ¨è®¾ç½®ä¸­é…ç½®å½±ç‰‡ç›®å½•ã€‚</p>';
                    allMediaList = []; // æ¸…ç©ºå½“å‰åˆ—è¡¨
                }
            });

            // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeIcon = document.querySelector('.theme-icon');
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¸»é¢˜åå¥½
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
                updateThemeIcon(savedTheme);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„ä¸»é¢˜åå¥½ï¼Œä½†ç³»ç»Ÿåå¥½æš—è‰²æ¨¡å¼
                document.body.setAttribute('data-theme', 'dark');
                updateThemeIcon('dark');
            }
            
            // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                // åªæœ‰ç”¨æˆ·æ²¡æœ‰æ‰‹åŠ¨é€‰æ‹©ä¸»é¢˜æ—¶ï¼Œæ‰è·Ÿéšç³»ç»Ÿä¸»é¢˜
                if (!localStorage.getItem('theme')) {
                    const newTheme = e.matches ? 'dark' : 'light';
                    document.body.setAttribute('data-theme', newTheme);
                    updateThemeIcon(newTheme);
                }
            });
            
            // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            themeToggleBtn.addEventListener('click', () => {
                const currentTheme = document.body.getAttribute('data-theme') || 
                                  (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                // ä¿å­˜ç”¨æˆ·é€‰æ‹©çš„ä¸»é¢˜
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // æ›´æ–°å›¾æ ‡
                updateThemeIcon(newTheme);
            });
            
            // æ›´æ–°ä¸»é¢˜å›¾æ ‡å‡½æ•°
            function updateThemeIcon(theme) {
                const themeIcon = document.querySelector('.theme-icon');
                if (theme === 'dark') {
                    themeIcon.textContent = 'â˜€ï¸';
                    themeIcon.title = 'åˆ‡æ¢åˆ°äº®è‰²ä¸»é¢˜';
                } else {
                    themeIcon.textContent = 'ğŸŒ™';
                    themeIcon.title = 'åˆ‡æ¢åˆ°æš—è‰²ä¸»é¢˜';
                }
            }

            // åœ¨ç°æœ‰è„šæœ¬ä¸­æ·»åŠ çª—å£æ§åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            const minimizeBtn = document.getElementById('minimize-btn');
            const maximizeBtn = document.getElementById('maximize-btn');
            const closeBtn = document.getElementById('close-btn');

            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', () => {
                    ipcRenderer.send('minimize-window');
                });
            }
            if (maximizeBtn) {
                maximizeBtn.addEventListener('click', () => {
                    ipcRenderer.send('maximize-restore-window');
                });
            }
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    ipcRenderer.send('close-window');
                });
            }

            // ç›‘å¬çª—å£æœ€å¤§åŒ–çŠ¶æ€å˜åŒ–
            ipcRenderer.on('window-maximized', (event, isMaximized) => {
                maximizeBtn.textContent = isMaximized ? 'â' : 'â–¡';
            });

        });

        // æ ¹æ®å½“å‰æ’åºå’Œè¿‡æ»¤æ¡ä»¶æ¸²æŸ“åª’ä½“åˆ—è¡¨
        function renderMediaList(mediaList) {
            const movieCoversDiv = document.getElementById('movie-covers');
            const sortBy = document.getElementById('sort-by').value;
            const sortOrder = document.getElementById('sort-order').value; // è·å–æ’åºé¡ºåº
            const filterActor = document.getElementById('filter-actor').value.toLowerCase();
            const filterStudio = document.getElementById('filter-studio').value.toLowerCase();
            const filterGenre = document.getElementById('filter-genre').value.toLowerCase(); // è·å–ç±»åˆ«è¿‡æ»¤å€¼

            // è¿‡æ»¤
            const filteredList = mediaList.filter(movie => {
                const matchActor = filterActor === '' || (movie.actors && movie.actors.some(actor => actor.toLowerCase().includes(filterActor)));
                const matchStudio = filterStudio === '' || (movie.studio && movie.studio.toLowerCase().includes(filterStudio));
                const matchGenre = filterGenre === '' || (movie.genres && movie.genres.some(genre => genre.toLowerCase().includes(filterGenre))); // ç±»åˆ«è¿‡æ»¤é€»è¾‘
                // å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šè¿‡æ»¤æ¡ä»¶
                return matchActor && matchStudio && matchGenre;
            });


            // æ’åº
            const sortedList = filteredList.sort((a, b) => {
                let compareResult = 0;
                if (sortBy === 'title') {
                    compareResult = a.title.localeCompare(b.title);
                } else if (sortBy === 'releaseDate') {
                    const dateA = a.releaseDateFull ? new Date(a.releaseDateFull) : new Date(0);
                    const dateB = b.releaseDateFull ? new Date(b.releaseDateFull) : new Date(0);
                    compareResult = dateA.getTime() - dateB.getTime();
                }

                // æ ¹æ®æ’åºé¡ºåºè°ƒæ•´ç»“æœ
                if (sortOrder === 'desc') {
                    return -compareResult; // é™åº
                }
                return compareResult; // å‡åº
            });

            // æ¸…ç©ºå½“å‰æ˜¾ç¤º
            movieCoversDiv.innerHTML = '';

            // æ¸²æŸ“è¿‡æ»¤å’Œæ’åºåçš„åˆ—è¡¨
            if (sortedList.length > 0) {
                sortedList.forEach(movie => {
                    const movieElement = document.createElement('div');
                    movieElement.classList.add('movie-item');
                    // å°†å½±ç‰‡è·¯å¾„å­˜å‚¨åœ¨ data å±æ€§ä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
                    movieElement.dataset.videoPath = movie.videoPath;

                    // æ·»åŠ å³é”®ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                    movieElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
                        const videoPath = e.currentTarget.dataset.videoPath;
                        ipcRenderer.send('show-context-menu', videoPath);
                    });

                    // å°é¢å›¾ç‰‡
                    if (movie.coverImageDataUrl) {
                        const coverElement = document.createElement('img');
                        coverElement.src = movie.coverImageDataUrl;
                        coverElement.alt = movie.title;
                        coverElement.style.cursor = 'pointer';

                        coverElement.addEventListener('click', () => {
                            ipcRenderer.send('open-video', movie.videoPath);
                        });

                        movieElement.appendChild(coverElement);
                    } else {
                        const noCoverElement = document.createElement('p');
                        noCoverElement.textContent = 'æ— å°é¢';
                        movieElement.appendChild(noCoverElement);
                    }

                    // å½±ç‰‡ä¿¡æ¯åŒºåŸŸ
                    const movieInfoDiv = document.createElement('div');
                    movieInfoDiv.classList.add('movie-info');


                    const titleElement = document.createElement('h3');
                    titleElement.textContent = movie.title;
                    movieInfoDiv.appendChild(titleElement);

                    // æ˜¾ç¤ºå®Œæ•´å‘å¸ƒæ—¥æœŸ (å¦‚æœå­˜åœ¨)
                    if (movie.releaseDateFull) {
                        const dateElement = document.createElement('p');
                        // ç®€å•æ˜¾ç¤ºå®Œæ•´æ—¥æœŸå­—ç¬¦ä¸²ï¼Œä½ å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œæ ¼å¼åŒ–
                        dateElement.textContent = `å‘å¸ƒæ—¥æœŸ: ${movie.releaseDateFull}`;
                        movieInfoDiv.appendChild(dateElement);
                    }

                    // æ˜¾ç¤ºç‰‡å•† (å¦‚æœå­˜åœ¨) å¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    if (movie.studio) {
                        const studioElement = document.createElement('p');
                        const studioLabel = document.createElement('span');
                        studioLabel.textContent = 'ç‰‡å•†: ';
                        studioElement.appendChild(studioLabel);

                        const studioNameSpan = document.createElement('span'); // ç‰‡å•†åç§°
                        studioNameSpan.textContent = movie.studio;
                        studioNameSpan.classList.add('clickable-text'); // æ·»åŠ clickable-textç±»
                        studioNameSpan.style.cursor = 'pointer'; // æ·»åŠ æ‰‹å‹å…‰æ ‡
                        studioNameSpan.style.textDecoration = 'underline'; // ä¸‹åˆ’çº¿ç°åœ¨ç”±CSSæ§åˆ¶
                        studioNameSpan.addEventListener('click', () => {
                            document.getElementById('filter-studio').value = movie.studio;
                            renderMediaList(allMediaList); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                        });
                        studioElement.appendChild(studioNameSpan);
                        movieInfoDiv.appendChild(studioElement);
                    }

                    // æ˜¾ç¤ºæ¼”å‘˜ (å¦‚æœå­˜åœ¨) å¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    if (movie.actors && movie.actors.length > 0) {
                        const actorsElement = document.createElement('p');
                        const actorsLabel = document.createElement('span');
                        actorsLabel.textContent = 'æ¼”å‘˜: ';
                        actorsElement.appendChild(actorsLabel);

                        const actorSpans = movie.actors.map(actor => {
                            const actorSpan = document.createElement('span');
                            actorSpan.textContent = actor;
                            actorSpan.classList.add('clickable-text'); // æ·»åŠ clickable-textç±»
                            actorSpan.style.cursor = 'pointer';
                            actorSpan.style.marginRight = '5px';
                            actorSpan.addEventListener('click', () => {
                                document.getElementById('filter-actor').value = actor;
                                renderMediaList(allMediaList); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                            });
                            return actorSpan;
                        });

                        actorSpans.forEach((span, index) => {
                            actorsElement.appendChild(span);
                            if (index < actorSpans.length - 1) {
                                actorsElement.appendChild(document.createTextNode(', ')); // æ·»åŠ é€—å·åˆ†éš”
                            }
                        });

                        movieInfoDiv.appendChild(actorsElement);
                    }

                    // æ˜¾ç¤ºç±»åˆ« (å¦‚æœå­˜åœ¨) å¹¶æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    if (movie.genres && movie.genres.length > 0) {
                        const genresElement = document.createElement('p');
                        const genresLabel = document.createElement('span');
                        genresLabel.textContent = 'ç±»åˆ«: ';
                        genresElement.appendChild(genresLabel);

                        const genreSpans = movie.genres.map(genre => {
                            const genreSpan = document.createElement('span');
                            genreSpan.textContent = genre;
                            genreSpan.classList.add('clickable-text'); // æ·»åŠ clickable-textç±»
                            genreSpan.style.cursor = 'pointer';
                            genreSpan.style.marginRight = '5px';
                            genreSpan.addEventListener('click', () => {
                                document.getElementById('filter-genre').value = genre; // å°†ç‚¹å‡»çš„ç±»åˆ«å¡«å……åˆ°è¿‡æ»¤æ¡†
                                renderMediaList(allMediaList); // é‡æ–°æ¸²æŸ“åˆ—è¡¨
                            });
                            return genreSpan;
                        });

                        genreSpans.forEach((span, index) => {
                            genresElement.appendChild(span);
                            if (index < genreSpans.length - 1) {
                                genresElement.appendChild(document.createTextNode(', ')); // æ·»åŠ é€—å·åˆ†éš”
                            }
                        });

                        movieInfoDiv.appendChild(genresElement);
                    }

                    // å¯ä»¥æ ¹æ®éœ€è¦æ˜¾ç¤ºç±»åˆ«ç­‰ä¿¡æ¯

                    movieElement.appendChild(movieInfoDiv); // å°†ä¿¡æ¯åŒºåŸŸæ·»åŠ åˆ°å¡ç‰‡ä¸­
                    movieCoversDiv.appendChild(movieElement);
                });
            } else {
                movieCoversDiv.textContent = 'æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„åª’ä½“æ–‡ä»¶ã€‚';
            }
        }

        // è·å–æ¨¡æ€æ¡†å…ƒç´ 
        const deleteModal = document.getElementById('delete-modal');
        const deletePathElement = document.getElementById('delete-path');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        let directoryToDelete = null; // å­˜å‚¨å¾…åˆ é™¤çš„ç›®å½•è·¯å¾„

        // ç›‘å¬ä¸»è¿›ç¨‹å‘é€çš„ç¡®è®¤åˆ é™¤æ¶ˆæ¯
        ipcRenderer.on('confirm-delete', (event, directoryPath) => {
            directoryToDelete = directoryPath; // å­˜å‚¨ç›®å½•è·¯å¾„
            deletePathElement.textContent = directoryPath; // åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºè·¯å¾„
            deleteModal.style.display = 'block'; // æ˜¾ç¤ºæ¨¡æ€æ¡†
        });

        // ç¡®è®¤åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        confirmDeleteBtn.addEventListener('click', () => {
            if (directoryToDelete) {
                ipcRenderer.send('delete-directory', directoryToDelete); // å‘é€åˆ é™¤è¯·æ±‚åˆ°ä¸»è¿›ç¨‹
                deleteModal.style.display = 'none'; // éšè—æ¨¡æ€æ¡†
                directoryToDelete = null; // æ¸…ç©ºå¾…åˆ é™¤ç›®å½•
            }
        });

        // å–æ¶ˆåˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶æˆ–ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.style.display = 'none'; // éšè—æ¨¡æ€æ¡†
            directoryToDelete = null; // æ¸…ç©ºå¾…åˆ é™¤ç›®å½•
        });

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) { // ç‚¹å‡»èƒŒæ™¯å…³é—­
                deleteModal.style.display = 'none';
                directoryToDelete = null;
            }
        });

        // ç›‘å¬ä¸»è¿›ç¨‹å‘é€çš„åˆ é™¤ç»“æœæ¶ˆæ¯ (å¯é€‰ï¼Œç”¨äºæ˜¾ç¤ºæç¤º)
        ipcRenderer.on('directory-deleted', (event, deletedDirectory) => {
            console.log(`ç›®å½• ${deletedDirectory} å·²åˆ é™¤ã€‚`);
            // TODO: é‡æ–°åŠ è½½åª’ä½“åˆ—è¡¨æˆ–ä»åˆ—è¡¨ä¸­ç§»é™¤å·²åˆ é™¤çš„é¡¹
            // ç®€å•ç²—æš´çš„æ–¹å¼ï¼šé‡æ–°æ‰«æç›®å½•å¹¶æ¸²æŸ“åˆ—è¡¨
            const directoryPath = 'd:\\Porn'; // ç¡®ä¿è¿™é‡Œæ˜¯æ­£ç¡®çš„æ ¹ç›®å½•
            ipcRenderer.invoke('scan-directory', directoryPath).then(updatedMediaList => {
                allMediaList = updatedMediaList;
                renderMediaList(allMediaList);
            });
        });

        ipcRenderer.on('delete-failed', (event, directoryPath, errorMessage) => {
            console.error(`åˆ é™¤ç›®å½• ${directoryPath} å¤±è´¥: ${errorMessage}`);
            // TODO: å‘ç”¨æˆ·æ˜¾ç¤ºé”™è¯¯æç¤º
            alert(`åˆ é™¤ç›®å½• ${directoryPath} å¤±è´¥: ${errorMessage}`);
        });

        // æ·»åŠ  IPC ç›‘å¬å™¨æ¥å¤„ç†ä¸»è¿›ç¨‹å‘é€çš„æ¶ˆæ¯ (å¦‚æœéœ€è¦)
        // ipcRenderer.on('some-message', (event, arg) => {
        //   console.log(arg);
        // });

        // åœ¨ç°æœ‰è„šæœ¬ä¸­æ·»åŠ è®¾ç½®æ¨¡æ€æ¡†ç›¸å…³é€»è¾‘
        const settingsModal = document.getElementById('settings-modal');
        const settingsContent = document.getElementById('settings-content');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');

        // ä¿å­˜è®¾ç½®æŒ‰é’®äº‹ä»¶
        saveSettingsBtn.addEventListener('click', () => {
            const directoryInputs = document.querySelectorAll('#directory-list input');
            const directories = Array.from(directoryInputs).map(input => input.value);

            // å‘é€è®¾ç½®åˆ°ä¸»è¿›ç¨‹
            ipcRenderer.send('save-settings', { directories });
            
            // å…³é—­æ¨¡æ€æ¡†
            settingsModal.style.display = 'none';
        });

        // å–æ¶ˆè®¾ç½®æŒ‰é’®äº‹ä»¶
        cancelSettingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });
    </script>
</body>

</html>